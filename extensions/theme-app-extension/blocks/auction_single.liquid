{% comment %}
  Bidly Single Auction Block
  Displays a single auction with detailed bidding interface
{% endcomment %}

{%- liquid
  assign block_id = block.id
  assign section_id = section.id
  assign shop_domain = shop.permanent_domain
  assign app_proxy_url = '/apps/bidly'
  assign auction_id = block.settings.auction_id
-%}

<div id="bidly-single-auction-{{ block_id }}" 
     class="bidly-single-auction" 
     data-block-id="{{ block_id }}" 
     data-shop="{{ shop_domain }}" 
     data-auction-id="{{ auction_id }}" 
     {{ block.shopify_attributes }}
     style="{% if shop.design_mode %}min-height: 200px;{% endif %}">
  <div class="bidly-loading" id="bidly-loading-{{ block_id }}">
    <div class="bidly-spinner"></div>
    <p>Loading auction...</p>
  </div>
  
  <div class="bidly-error" id="bidly-error-{{ block_id }}" style="display: none;">
    <p>Unable to load auction. Please try again later.</p>
  </div>
  
  {% unless auction_id %}
  <div class="bidly-config-error" style="padding: 2rem; text-align: center; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; color: #856404;">
    <h3 style="margin: 0 0 1rem 0;">‚ö†Ô∏è Configuration Required</h3>
    <p style="margin: 0;">Please set an Auction ID in the block settings to display an auction.</p>
  </div>
  {% endunless %}
  
  <div class="bidly-auction-detail" id="bidly-auction-detail-{{ block_id }}" style="display: none;">
    <!-- Auction details will be populated by JavaScript -->
  </div>
  
  <!-- Theme Editor Placeholder -->
  <div class="bidly-theme-editor-placeholder" style="display: none;">
    <div style="padding: 2rem; text-align: center; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px;">
      <h3 style="margin: 0 0 1rem 0; color: #495057;">üéØ Single Auction</h3>
      <p style="margin: 0; color: #6c757d;">This block will display a specific auction when the theme is published.</p>
      <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 4px;">
        <p style="margin: 0; font-size: 0.9rem; color: #6c757d;">
          <strong>Settings:</strong><br>
          Auction ID: {{ block.settings.auction_id | default: 'Not set' }}<br>
          Title: {{ block.settings.title | default: 'Auction Details' }}<br>
          Show Bid History: {{ block.settings.show_bid_history | default: true }}
        </p>
      </div>
    </div>
  </div>
</div>

<style>
  .bidly-single-auction {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    max-width: 100%;
    margin: 0 auto;
  }
  
  .bidly-loading {
    text-align: center;
    padding: 2rem;
  }
  
  .bidly-spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: bidly-spin 1s linear infinite;
    margin: 0 auto 1rem;
  }
  
  @keyframes bidly-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .bidly-error {
    background-color: #fee;
    border: 1px solid #fcc;
    border-radius: 4px;
    padding: 1rem;
    text-align: center;
    color: #c33;
  }
  
  .bidly-auction-detail {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    align-items: start;
  }
  
  .bidly-auction-image-container {
    position: relative;
  }
  
  .bidly-auction-image {
    width: 100%;
    height: 400px;
    object-fit: contain;
    object-position: center;
    border-radius: 8px;
    background-color: #f8f9fa;
  }
  
  .bidly-auction-info {
    padding: 1rem 0;
  }
  
  .bidly-auction-title {
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 1rem;
    line-height: 1.3;
  }
  
  .bidly-auction-price {
    margin-bottom: 1rem;
  }
  
  .bidly-price-label {
    font-size: 0.9rem;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .bidly-price-amount {
    font-size: 2rem;
    font-weight: 700;
    color: #2c5aa0;
  }
  
  .bidly-starting-bid {
    font-size: 1rem;
    color: #888;
    margin-top: 0.5rem;
  }
  
  .bidly-auction-time {
    font-size: 1.1rem;
    color: #666;
    margin-bottom: 1.5rem;
  }
  
  .bidly-auction-status {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 1.5rem;
  }
  
  .bidly-status-active {
    background-color: #d4edda;
    color: #155724;
  }
  
  .bidly-status-pending {
    background-color: #fff3cd;
    color: #856404;
  }
  
  .bidly-status-ended {
    background-color: #f8d7da;
    color: #721c24;
  }
  
  .bidly-bidding-section {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }
  
  .bidly-bid-input {
    width: 100%;
    padding: 1rem;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 1.1rem;
    margin-bottom: 1rem;
    text-align: center;
  }
  
  .bidly-bid-input:focus {
    outline: none;
    border-color: #2c5aa0;
  }
  
  .bidly-bid-button {
    width: 100%;
    background-color: #2c5aa0;
    color: white;
    border: none;
    padding: 1rem;
    border-radius: 6px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s ease;
    margin-bottom: 0.5rem;
  }
  
  .bidly-bid-button:hover:not(:disabled) {
    background-color: #1e3f73;
  }
  
  .bidly-bid-button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }
  
  .bidly-buy-now-button {
    width: 100%;
    background-color: #28a745;
    color: white;
    border: none;
    padding: 1rem;
    border-radius: 6px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  
  .bidly-buy-now-button:hover:not(:disabled) {
    background-color: #1e7e34;
  }
  
  .bidly-buy-now-button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }
  
  .bidly-bid-history {
    margin-top: 1.5rem;
  }
  
  .bidly-bid-history h4 {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1rem;
  }
  
  .bidly-bid-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    border-bottom: 1px solid #eee;
  }
  
  .bidly-bid-item:last-child {
    border-bottom: none;
  }
  
  .bidly-bid-amount {
    font-weight: 600;
    color: #2c5aa0;
  }
  
  .bidly-bid-time {
    font-size: 0.9rem;
    color: #666;
  }
  
  @media (max-width: 768px) {
    .bidly-auction-detail {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    
    .bidly-auction-image {
      height: 250px;
    }
    
    .bidly-auction-title {
      font-size: 1.5rem;
    }
    
    .bidly-price-amount {
      font-size: 1.5rem;
    }
  }
</style>

<script>
  (function() {
    // Wait for DOM to be ready and avoid conflicts
    function initBidlyWidget() {
      const blockId = '{{ block_id }}';
      const shopDomain = '{{ shop_domain }}';
      const appProxyUrl = '{{ app_proxy_url }}';
      const auctionId = '{{ auction_id }}';
      
      console.log('üéØ Single Auction Block - initBidlyWidget called for blockId:', blockId);
      console.log('üéØ Single Auction Block - auctionId:', auctionId);
      console.log('üéØ Single Auction Block - shopDomain:', shopDomain);
      console.log('üéØ Single Auction Block - appProxyUrl:', appProxyUrl);
      
      // More robust theme editor detection
      const isThemeEditor = window.Shopify && (
        window.Shopify.designMode || 
        window.location.search.includes('preview_theme_id') ||
        document.body.classList.contains('shopify-design-mode') ||
        window.location.pathname.includes('editor')
      );
      
      console.log('üéØ Single Auction Block - Theme editor check:', {
        isThemeEditor: isThemeEditor,
        hasShopify: !!window.Shopify,
        designMode: window.Shopify?.designMode,
        search: window.location.search,
        bodyClasses: document.body.classList.toString(),
        pathname: window.location.pathname
      });
      
      if (isThemeEditor) {
        console.log('üé® Single Auction Block - Theme editor detected, showing placeholder');
        // Show placeholder immediately
        setTimeout(function() {
          const placeholder = document.querySelector(`#bidly-single-auction-${blockId} .bidly-theme-editor-placeholder`);
          const loading = document.querySelector(`#bidly-loading-${blockId}`);
          
          if (placeholder) placeholder.style.display = 'block';
          if (loading) loading.style.display = 'none';
        }, 50);
        return;
      }
      
      console.log('üéØ Single Auction Block - Not in theme editor, continuing with initialization');
      
      // Load the Bidly auction widget
      window.BidlyAuctionWidget = window.BidlyAuctionWidget || {};
      window.BidlyAuctionWidget.loadedInstances = window.BidlyAuctionWidget.loadedInstances || new Set();
      
      if (!window.BidlyAuctionWidget.loadedInstances.has(blockId)) {
        // Load CSS
        const cssLink = document.createElement('link');
        cssLink.rel = 'stylesheet';
        cssLink.href = '{{ "bidly-widget.css" | asset_url }}?v=2';
        cssLink.onerror = function() {
          console.warn('Bidly: Failed to load CSS');
        };
        document.head.appendChild(cssLink);
        
        // Load JavaScript
        const script = document.createElement('script');
        script.src = '{{ "bidly-widget.js" | asset_url }}?v=2018&t=' + Date.now();
        script.onload = function() {
          if (window.initBidlyBlock) {
            window.BidlyAuctionWidget.loadedInstances.add(blockId);
            window.initBidlyBlock(blockId, shopDomain, appProxyUrl, auctionId, 'single');
          } else if (window.BidlyAuctionWidget && window.BidlyAuctionWidget.initSingle) {
            window.BidlyAuctionWidget.loadedInstances.add(blockId);
            window.BidlyAuctionWidget.initSingle(blockId, shopDomain, appProxyUrl, auctionId);
          }
        };
        script.onerror = function() {
          console.error('Bidly: Failed to load JavaScript');
        };
        document.head.appendChild(script);
        
        window.BidlyAuctionWidget.loaded = true;
      } else {
        // Widget already loaded, initialize this block
        console.log('üîÑ Widget already loaded, trying to initialize single block:', blockId);
        console.log('üîÑ window.initBidlyBlock available:', !!window.initBidlyBlock);
        console.log('üîÑ window.BidlyAuctionWidget available:', !!window.BidlyAuctionWidget);
        console.log('üîÑ window.BidlyAuctionWidget.initSingle available:', !!(window.BidlyAuctionWidget && window.BidlyAuctionWidget.initSingle));
        
        // Force initialization by calling the global function directly
        if (window.initBidlyBlock) {
          console.log('‚úÖ Using window.initBidlyBlock');
          window.initBidlyBlock(blockId, shopDomain, appProxyUrl, auctionId, 'single');
        } else if (window.BidlyAuctionWidget && window.BidlyAuctionWidget.initSingle) {
          console.log('‚úÖ Using window.BidlyAuctionWidget.initSingle');
          window.BidlyAuctionWidget.initSingle(blockId, shopDomain, appProxyUrl, auctionId);
        } else {
          console.error('‚ùå No initialization method available for single block');
          // Fallback: try to initialize manually
          console.log('üîÑ Attempting manual initialization...');
          console.log('üîÑ window.BidlyAuctionWidget available:', !!window.BidlyAuctionWidget);
          console.log('üîÑ window.BidlyAuctionWidget.ensureLoadedInstances available:', !!(window.BidlyAuctionWidget && window.BidlyAuctionWidget.ensureLoadedInstances));
          
          if (window.BidlyAuctionWidget) {
            console.log('üîÑ Calling ensureLoadedInstances...');
            window.BidlyAuctionWidget.ensureLoadedInstances();
            
            console.log('üîÑ Creating instance for blockId:', blockId);
            window.BidlyAuctionWidget.instances[blockId] = {
              blockId: blockId,
              shopDomain: shopDomain,
              appProxyUrl: appProxyUrl,
              auctionId: auctionId,
              type: 'single'
            };
            
            console.log('üîÑ Calling initializeCustomerAuth...');
            window.BidlyAuctionWidget.initializeCustomerAuth(blockId);
            
            console.log('üîÑ Calling initializeSocket...');
            window.BidlyAuctionWidget.initializeSocket();
            
            console.log('üîÑ Calling loadSingleAuction...');
            window.BidlyAuctionWidget.loadSingleAuction(blockId, auctionId);
            
            console.log('‚úÖ Manual initialization completed for single block');
            console.log('üìã All instances after manual init:', Object.keys(window.BidlyAuctionWidget.instances));
          } else {
            console.error('‚ùå window.BidlyAuctionWidget not available for manual initialization');
          }
        }
      }
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initBidlyWidget);
    } else {
      initBidlyWidget();
    }
  })();
</script>

{% schema %}
{
  "name": "Single Auction",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "auction_id",
      "label": "Auction ID",
      "info": "Enter the specific auction ID to display"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Auction Details"
    },
    {
      "type": "checkbox",
      "id": "show_bid_history",
      "label": "Show Bid History",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_buy_now",
      "label": "Show Buy Now Button",
      "default": true
    }
  ]
}
{% endschema %}
