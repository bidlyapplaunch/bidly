{% comment %}
  Bidly Featured Auction Block
  Displays a single featured auction prominently
{% endcomment %}

{%- liquid
  assign block_id = block.id
  assign section_id = section.id
  assign shop_domain = shop.permanent_domain
  assign app_proxy_url = '/apps/bidly'
  assign auction_id = block.settings.auction_id
-%}

<div id="bidly-featured-auction-{{ block_id }}" 
     class="bidly-featured-auction" 
     data-block-id="{{ block_id }}" 
     data-shop="{{ shop_domain }}" 
     data-auction-id="{{ auction_id }}" 
     {{ block.shopify_attributes }}
     style="{% if shop.design_mode %}min-height: 200px;{% endif %}">
  <div class="bidly-loading" id="bidly-loading-{{ block_id }}">
    <div class="bidly-spinner"></div>
    <p>Loading featured auction...</p>
  </div>
  
  <div class="bidly-error" id="bidly-error-{{ block_id }}" style="display: none;">
    <p>Unable to load featured auction. Please try again later.</p>
  </div>
  
  <div class="bidly-featured-container" id="bidly-featured-container-{{ block_id }}" style="display: none;">
    <div class="bidly-featured-badge">Featured Auction</div>
    <!-- Featured auction content will be populated by JavaScript -->
  </div>
  
  <!-- Theme Editor Placeholder -->
  <div class="bidly-theme-editor-placeholder" style="display: none;">
    <div style="padding: 2rem; text-align: center; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px;">
      <h3 style="margin: 0 0 1rem 0; color: #495057;">‚≠ê Featured Auction</h3>
      <p style="margin: 0; color: #6c757d;">This block will display a featured auction when the theme is published.</p>
      <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 4px;">
        <p style="margin: 0; font-size: 0.9rem; color: #6c757d;">
          <strong>Settings:</strong><br>
          Featured Auction ID: {{ block.settings.auction_id | default: 'Not set' }}<br>
          Title: {{ block.settings.title | default: 'Featured Auction' }}<br>
          Show Buy Now: {{ block.settings.show_buy_now | default: true }}
        </p>
      </div>
    </div>
  </div>
</div>

<style>
  .bidly-featured-auction {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    max-width: 100%;
    margin: 0 auto;
    position: relative;
  }
  
  .bidly-loading {
    text-align: center;
    padding: 3rem;
  }
  
  .bidly-spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: bidly-spin 1s linear infinite;
    margin: 0 auto 1rem;
  }
  
  @keyframes bidly-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .bidly-error {
    background-color: #fee;
    border: 1px solid #fcc;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    color: #c33;
  }
  
  .bidly-featured-container {
    position: relative;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  }
  
  .bidly-featured-badge {
    position: absolute;
    top: 1rem;
    left: 1rem;
    background-color: #ff6b6b;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    z-index: 10;
  }
  
  .bidly-featured-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    min-height: 400px;
    color: white;
  }
  
  .bidly-featured-image-container {
    position: relative;
    overflow: hidden;
  }
  
  .bidly-featured-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
    object-position: center;
    opacity: 0.9;
    background-color: #f8f9fa;
  }
  
  .bidly-featured-info {
    padding: 2rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  
  .bidly-featured-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 1rem;
    line-height: 1.2;
    color: white;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
  }
  
  .bidly-featured-price {
    margin-bottom: 1rem;
  }
  
  .bidly-price-label {
    font-size: 0.9rem;
    color: white;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
  }
  
  .bidly-price-amount {
    font-size: 2.5rem;
    font-weight: 800;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    color: white;
  }
  
  .bidly-starting-bid {
    font-size: 1.1rem;
    color: white;
    margin-top: 0.5rem;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
  }
  
  .bidly-featured-time {
    font-size: 1.2rem;
    margin-bottom: 2rem;
    opacity: 0.9;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
  }
  
  .bidly-featured-status {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 2rem;
    background-color: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
  }
  
  .bidly-featured-bidding {
    display: flex;
    gap: 1rem;
    align-items: center;
  }
  
  .bidly-featured-bid-input {
    flex: 1;
    padding: 1rem;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 8px;
    font-size: 1.1rem;
    background-color: rgba(255,255,255,0.1);
    color: white;
    backdrop-filter: blur(10px);
  }
  
  .bidly-featured-bid-input::placeholder {
    color: rgba(255,255,255,0.7);
  }
  
  .bidly-featured-bid-input:focus {
    outline: none;
    border-color: rgba(255,255,255,0.6);
  }
  
  .bidly-featured-bid-button {
    background-color: #ff6b6b;
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
  }
  
  .bidly-featured-bid-button:hover:not(:disabled) {
    background-color: #ff5252;
    transform: translateY(-2px);
  }
  
  .bidly-featured-bid-button:disabled {
    background-color: rgba(255,255,255,0.3);
    cursor: not-allowed;
    transform: none;
  }
  
  .bidly-featured-buy-now {
    margin-top: 1rem;
  }
  
  .bidly-featured-buy-now-button {
    width: 100%;
    background-color: #4ecdc4;
    color: white;
    border: none;
    padding: 1rem;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .bidly-featured-buy-now-button:hover:not(:disabled) {
    background-color: #45b7b8;
    transform: translateY(-2px);
  }
  
  .bidly-featured-buy-now-button:disabled {
    background-color: rgba(255,255,255,0.3);
    cursor: not-allowed;
    transform: none;
  }
  
  @media (max-width: 768px) {
    .bidly-featured-content {
      grid-template-columns: 1fr;
      min-height: auto;
    }
    
    .bidly-featured-image-container {
      height: 250px;
    }
    
    .bidly-featured-info {
      padding: 1.5rem;
    }
    
    .bidly-featured-title {
      font-size: 1.5rem;
    }
    
    .bidly-price-amount {
      font-size: 2rem;
    }
    
    .bidly-featured-bidding {
      flex-direction: column;
    }
    
    .bidly-featured-bid-button {
      width: 100%;
    }
  }
</style>

<script>
  (function() {
    // Wait for DOM to be ready and avoid conflicts
    function initBidlyWidget() {
      const blockId = '{{ block_id }}';
      const shopDomain = '{{ shop_domain }}';
      const appProxyUrl = '{{ app_proxy_url }}';
      const auctionId = '{{ auction_id }}';
      
      console.log('üéØ Featured Auction Block - initBidlyWidget called for blockId:', blockId);
      console.log('üéØ Featured Auction Block - auctionId:', auctionId);
      console.log('üéØ Featured Auction Block - shopDomain:', shopDomain);
      console.log('üéØ Featured Auction Block - appProxyUrl:', appProxyUrl);
      
      // More robust theme editor detection
      const isThemeEditor = window.Shopify && (
        window.Shopify.designMode || 
        window.location.search.includes('preview_theme_id') ||
        document.body.classList.contains('shopify-design-mode') ||
        window.location.pathname.includes('editor')
      );
      
      console.log('üéØ Featured Auction Block - Theme editor check:', {
        isThemeEditor: isThemeEditor,
        hasShopify: !!window.Shopify,
        designMode: window.Shopify?.designMode,
        search: window.location.search,
        bodyClasses: document.body.classList.toString(),
        pathname: window.location.pathname
      });
      
      if (isThemeEditor) {
        console.log('üé® Featured Auction Block - Theme editor detected, showing placeholder');
        // Show placeholder immediately
        setTimeout(function() {
          const placeholder = document.querySelector(`#bidly-featured-auction-${blockId} .bidly-theme-editor-placeholder`);
          const loading = document.querySelector(`#bidly-loading-${blockId}`);
          
          if (placeholder) placeholder.style.display = 'block';
          if (loading) loading.style.display = 'none';
        }, 50);
        return;
      }
      
      console.log('üéØ Featured Auction Block - Not in theme editor, continuing with initialization');
      
      // Load the Bidly auction widget
      window.BidlyAuctionWidget = window.BidlyAuctionWidget || {};
      window.BidlyAuctionWidget.loadedInstances = window.BidlyAuctionWidget.loadedInstances || new Set();
      
      if (!window.BidlyAuctionWidget.loadedInstances.has(blockId)) {
        // Load CSS
        const cssLink = document.createElement('link');
        cssLink.rel = 'stylesheet';
        cssLink.href = '{{ "bidly-widget.css" | asset_url }}?v=2';
        cssLink.onerror = function() {
          console.warn('Bidly: Failed to load CSS');
        };
        document.head.appendChild(cssLink);
        
        // Load JavaScript
        const script = document.createElement('script');
        script.src = '{{ "bidly-widget.js" | asset_url }}?v=2005&t=' + Date.now();
        script.onload = function() {
          if (window.initBidlyBlock) {
            window.BidlyAuctionWidget.loadedInstances.add(blockId);
            window.initBidlyBlock(blockId, shopDomain, appProxyUrl, auctionId, 'featured');
          } else if (window.BidlyAuctionWidget && window.BidlyAuctionWidget.initFeatured) {
            window.BidlyAuctionWidget.loadedInstances.add(blockId);
            window.BidlyAuctionWidget.initFeatured(blockId, shopDomain, appProxyUrl, auctionId);
          }
        };
        script.onerror = function() {
          console.error('Bidly: Failed to load JavaScript');
        };
        document.head.appendChild(script);
        
        window.BidlyAuctionWidget.loaded = true;
      } else {
        // Widget already loaded, initialize this block
        console.log('üîÑ Widget already loaded, trying to initialize featured block:', blockId);
        console.log('üîÑ window.initBidlyBlock available:', !!window.initBidlyBlock);
        console.log('üîÑ window.BidlyAuctionWidget available:', !!window.BidlyAuctionWidget);
        console.log('üîÑ window.BidlyAuctionWidget.initFeatured available:', !!(window.BidlyAuctionWidget && window.BidlyAuctionWidget.initFeatured));
        
        // Force initialization by calling the global function directly
        if (window.initBidlyBlock) {
          console.log('‚úÖ Using window.initBidlyBlock');
          window.initBidlyBlock(blockId, shopDomain, appProxyUrl, auctionId, 'featured');
        } else if (window.BidlyAuctionWidget && window.BidlyAuctionWidget.initFeatured) {
          console.log('‚úÖ Using window.BidlyAuctionWidget.initFeatured');
          window.BidlyAuctionWidget.initFeatured(blockId, shopDomain, appProxyUrl, auctionId);
        } else {
          console.error('‚ùå No initialization method available for featured block');
          // Fallback: try to initialize manually
          console.log('üîÑ Attempting manual initialization...');
          console.log('üîÑ window.BidlyAuctionWidget available:', !!window.BidlyAuctionWidget);
          console.log('üîÑ window.BidlyAuctionWidget.ensureLoadedInstances available:', !!(window.BidlyAuctionWidget && window.BidlyAuctionWidget.ensureLoadedInstances));
          
          if (window.BidlyAuctionWidget) {
            console.log('üîÑ Calling ensureLoadedInstances...');
            window.BidlyAuctionWidget.ensureLoadedInstances();
            
            console.log('üîÑ Creating instance for blockId:', blockId);
            window.BidlyAuctionWidget.instances[blockId] = {
              blockId: blockId,
              shopDomain: shopDomain,
              appProxyUrl: appProxyUrl,
              auctionId: auctionId,
              type: 'featured'
            };
            
            console.log('üîÑ Calling initializeCustomerAuth...');
            window.BidlyAuctionWidget.initializeCustomerAuth(blockId);
            
            console.log('üîÑ Calling initializeSocket...');
            window.BidlyAuctionWidget.initializeSocket();
            
            console.log('üîÑ Calling loadSingleAuction...');
            window.BidlyAuctionWidget.loadSingleAuction(blockId, auctionId);
            
            console.log('‚úÖ Manual initialization completed for featured block');
            console.log('üìã All instances after manual init:', Object.keys(window.BidlyAuctionWidget.instances));
          } else {
            console.error('‚ùå window.BidlyAuctionWidget not available for manual initialization');
          }
        }
      }
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initBidlyWidget);
    } else {
      initBidlyWidget();
    }
  })();
</script>

{% schema %}
{
  "name": "Featured Auction",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "auction_id",
      "label": "Featured Auction ID",
      "info": "Enter the auction ID to feature prominently"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Featured Auction"
    },
    {
      "type": "checkbox",
      "id": "show_buy_now",
      "label": "Show Buy Now Button",
      "default": true
    },
    {
      "type": "select",
      "id": "style",
      "label": "Display Style",
      "options": [
        {
          "value": "gradient",
          "label": "Gradient Background"
        },
        {
          "value": "minimal",
          "label": "Minimal Style"
        }
      ],
      "default": "gradient"
    }
  ]
}
{% endschema %}
