{% comment %}
  Auction App Embed - Automatically detects and overlays on auction products
  This appears in the "App embeds" section of theme customization
  No manual placement needed - just enable/disable
{% endcomment %}

{% schema %}
{
  "name": "Auction App Embed",
  "target": "body",
  "settings": [
    {
      "type": "header",
      "content": "Auction Widget Settings"
    },
    {
      "type": "checkbox",
      "id": "show_timer",
      "label": "Show countdown timer",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_bid_history",
      "label": "Show bid history link",
      "default": true
    },
    {
      "type": "select",
      "id": "widget_position",
      "label": "Widget position",
      "options": [
        {
          "value": "below_price",
          "label": "Below product price"
        },
        {
          "value": "above_price",
          "label": "Above product price"
        },
        {
          "value": "replace_price",
          "label": "Replace product price"
        }
      ],
      "default": "below_price"
    }
  ]
}
{% endschema %}

<link rel="stylesheet" href="{{ 'auction-app-embed.css' | asset_url }}?v=199">

<meta id="bidly-product-id" data-product-id="{{ product.id }}">

<!-- Inject Shopify customer data -->
<script>
  window.customerData = {
    id: {{ customer.id | json }},
    email: {{ customer.email | json }},
    first_name: {{ customer.first_name | json }},
    last_name: {{ customer.last_name | json }}
  };
  console.log('Bidly: Shopify customer data injected:', window.customerData);
</script>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js" defer></script>
<script src="{{ 'bidly-debug-utils.js' | asset_url }}?v=199" defer></script>
<script src="{{ 'backendConfig.js' | asset_url }}?v=199" defer></script>
<script src="{{ 'bidly-hybrid-login.js' | asset_url }}?v=199" defer></script>
<script src="{{ 'auction-widget-simple.js' | asset_url }}?v=199" defer></script>
<script src="{{ 'auction-app-embed.js' | asset_url }}?v=199" defer></script>

<script>
// Initialize the auction app embed
window.BidlyAuctionEmbed = {
    init: function() {
        console.log('Bidly: Initializing auction app embed...');
        
        // Get settings from block
        const settings = {
            show_timer: {{ block.settings.show_timer | default: true }},
            show_bid_history: {{ block.settings.show_bid_history | default: true }},
            widget_position: '{{ block.settings.widget_position | default: "below_price" }}'
        };
        
        // Check if product has auction data
        this.checkProductMetafields().then(auctionCheck => {
            if (auctionCheck.hasAuction) {
                console.log('Bidly: Product has auction data, injecting widget...', auctionCheck);
                this.injectWidget(auctionCheck, settings);
            } else {
                console.log('Bidly: No auction data found for this product');
            }
        });
    },
    
    checkProductMetafields: async function() {
        try {
            // Try to get product data from Shopify's global objects
            if (window.Shopify?.analytics?.meta?.product) {
                const product = window.Shopify.analytics.meta.product;
                
                // Check if product has auction metafields
                if (product.metafields && product.metafields.auction) {
                    const mf = product.metafields.auction;
                    const isAuction = mf.is_auction?.value === true || mf.is_auction?.value === 'true' || mf.is_auction === true || mf.is_auction === 'true';
                    const auctionId = mf.auction_id?.value || mf.auction_id;
                    if (isAuction && auctionId) {
                        return {
                            hasAuction: true,
                            auctionId: auctionId,
                            status: mf.status?.value || mf.status || 'pending',
                            currentBid: parseFloat(mf.current_bid?.value ?? mf.current_bid ?? 0) || 0,
                            startingBid: parseFloat(mf.starting_bid?.value ?? mf.starting_bid ?? 0) || 0,
                            reservePrice: parseFloat(mf.reserve_price?.value ?? mf.reserve_price ?? 0) || 0,
                            endTime: mf.end_time?.value || mf.end_time,
                            startTime: mf.start_time?.value || mf.start_time,
                            bidCount: parseInt(mf.bid_count?.value ?? mf.bid_count ?? 0) || 0,
                            buyNowPrice: parseFloat(mf.buy_now_price?.value ?? mf.buy_now_price ?? 0) || 0
                        };
                    }
                }
            }

            // Fallback: try to get from product JSON script tag
            const productJson = document.querySelector('script[type="application/json"][data-product-json]');
            if (productJson) {
                try {
                    const product = JSON.parse(productJson.textContent);
                    if (product.metafields && product.metafields.auction) {
                        const mf = product.metafields.auction;
                        const isAuction = mf.is_auction?.value === true || mf.is_auction?.value === 'true' || mf.is_auction === true || mf.is_auction === 'true';
                        const auctionId = mf.auction_id?.value || mf.auction_id;
                        if (isAuction && auctionId) {
                            return {
                                hasAuction: true,
                                auctionId: auctionId,
                                status: mf.status?.value || mf.status || 'pending',
                                currentBid: parseFloat(mf.current_bid?.value ?? mf.current_bid ?? 0) || 0,
                                startingBid: parseFloat(mf.starting_bid?.value ?? mf.starting_bid ?? 0) || 0,
                                reservePrice: parseFloat(mf.reserve_price?.value ?? mf.reserve_price ?? 0) || 0,
                                endTime: mf.end_time?.value || mf.end_time,
                                startTime: mf.start_time?.value || mf.start_time,
                                bidCount: parseInt(mf.bid_count?.value ?? mf.bid_count ?? 0) || 0,
                                buyNowPrice: parseFloat(mf.buy_now_price?.value ?? mf.buy_now_price ?? 0) || 0
                            };
                        }
                    }
                } catch (e) {
                    console.warn('Bidly: Error parsing product JSON:', e);
                }
            }

            // If metafields not found, fallback to API call
            console.log('Bidly: Metafields not found, falling back to API...');
            const productId = await this.getProductIdForApi();
            if (!productId) {
                console.log('Bidly: Could not get product ID for API fallback');
                return { hasAuction: false };
            }
            
            // Call the API endpoint
            try {
                // Use backend config if available
                const backendUrl = window.BidlyBackendConfig 
                    ? window.BidlyBackendConfig.getBackendUrl('{{ shop.domain }}')
                    : 'https://bidly-auction-backend.onrender.com';
                
                const CONFIG = window.BidlyConfig || {
                    backendUrl: backendUrl,
                    shopDomain: '{{ shop.domain }}'
                };
                
                const apiUrl = `${CONFIG.backendUrl}/api/auctions/by-product/${productId}?shop=${CONFIG.shopDomain}`;
                console.log('Bidly: Fetching auction data from API:', apiUrl);
                
                const response = await fetch(apiUrl);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.auction) {
                        console.log('Bidly: Found auction via API:', data.auction);
                        return {
                            hasAuction: true,
                            auctionId: data.auction._id,
                            status: data.auction.status || 'pending',
                            currentBid: parseFloat(data.auction.currentBid) || 0,
                            startingBid: parseFloat(data.auction.startingBid) || 0,
                            reservePrice: parseFloat(data.auction.reservePrice) || 0,
                            endTime: data.auction.endTime,
                            startTime: data.auction.startTime,
                            bidCount: data.auction.bidHistory?.length || 0,
                            buyNowPrice: parseFloat(data.auction.buyNowPrice) || 0
                        };
                    }
                }
            } catch (apiError) {
                console.warn('Bidly: API fallback failed:', apiError);
            }

            return { hasAuction: false };
        } catch (error) {
            console.warn('Bidly: Error checking product metafields:', error);
            return { hasAuction: false };
        }
    },
    
    getProductIdForApi: async function() {
        // Try to get product ID from various sources
        const metaProduct = document.querySelector('#bidly-product-id');
        if (metaProduct && metaProduct.dataset.productId) {
            return metaProduct.dataset.productId;
        }
        
        if (window.Shopify?.analytics?.meta?.product?.id) {
            return window.Shopify.analytics.meta.product.id.toString();
        }
        
        const productJson = document.querySelector('script[type="application/json"][data-product-json]');
        if (productJson) {
            try {
                const product = JSON.parse(productJson.textContent);
                if (product.id) {
                    return product.id.toString();
                }
            } catch (e) {
                console.warn('Bidly: Error parsing product JSON:', e);
            }
        }
        
        if (window.Shopify?.product?.id) {
            return window.Shopify.product.id.toString();
        }
        
        return null;
    },
    
    injectWidget: function(auctionData, settings) {
        // This will be handled by the external JavaScript file
        if (window.BidlyAuctionWidget) {
            window.BidlyAuctionWidget.inject(auctionData, settings);
        }
    }
};

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        window.BidlyAuctionEmbed.init();
    });
} else {
    window.BidlyAuctionEmbed.init();
}
</script>