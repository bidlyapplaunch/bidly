{% comment %}
  Bidly Auction List Block
  Displays a list of active auctions for customers to view and bid on
{% endcomment %}

{%- liquid
  assign block_id = block.id
  assign section_id = section.id
  assign shop_domain = shop.permanent_domain
  assign app_proxy_url = '/apps/bidly'
-%}

<div id="bidly-auction-list-{{ block_id }}" 
     class="bidly-auction-list" 
     data-block-id="{{ block_id }}" 
     data-shop="{{ shop_domain }}" 
     {{ block.shopify_attributes }}
     style="{% if shop.design_mode %}min-height: 200px;{% endif %}">
  <div class="bidly-loading" id="bidly-loading-{{ block_id }}">
    <div class="bidly-spinner"></div>
    <p>Loading auctions...</p>
  </div>
  
  <div class="bidly-error" id="bidly-error-{{ block_id }}" style="display: none;">
    <p>Unable to load auctions. Please try again later.</p>
  </div>
  
  <div class="bidly-auctions-container" id="bidly-auctions-{{ block_id }}" style="display: none;">
    <h3 class="bidly-section-title">{{ block.settings.title | default: 'Live Auctions' }}</h3>
    <div class="bidly-auctions-grid" id="bidly-grid-{{ block_id }}">
      <!-- Auctions will be populated by JavaScript -->
    </div>
  </div>
  
  <!-- Theme Editor Placeholder -->
  <div class="bidly-theme-editor-placeholder" style="display: none;">
    <div style="padding: 2rem; text-align: center; background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px;">
      <h3 style="margin: 0 0 1rem 0; color: #495057;">🎯 Bidly Auction List</h3>
      <p style="margin: 0; color: #6c757d;">This block will display live auctions when the theme is published.</p>
      <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 4px;">
        <p style="margin: 0; font-size: 0.9rem; color: #6c757d;">
          <strong>Settings:</strong><br>
          Title: {{ block.settings.title | default: 'Live Auctions' }}<br>
          Max Auctions: {{ block.settings.max_auctions | default: 6 }}<br>
          Show Ended: {{ block.settings.show_ended | default: false }}
        </p>
      </div>
    </div>
  </div>
</div>

<style>
  .bidly-auction-list {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    max-width: 100%;
    margin: 0 auto;
    position: relative;
    z-index: 1;
  }
  
  /* Hide in theme editor to prevent conflicts */
  .shopify-section-group-header .bidly-auction-list,
  .shopify-section-group-footer .bidly-auction-list {
    display: none !important;
  }
  
  /* Prevent theme conflicts */
  .bidly-auction-list * {
    box-sizing: border-box;
  }
  
  .bidly-auction-list input,
  .bidly-auction-list button {
    font-family: inherit;
  }
  
  /* Hide loading state in theme editor */
  .shopify-design-mode .bidly-loading {
    display: none !important;
  }
  
  .shopify-design-mode .bidly-theme-editor-placeholder {
    display: block !important;
  }
  
  /* Force theme editor styles */
  .shopify-design-mode #bidly-auction-list-{{ block_id }} .bidly-loading,
  .shopify-design-mode #bidly-auction-list-{{ block_id }} .bidly-auctions-container {
    display: none !important;
  }

  .shopify-design-mode #bidly-auction-list-{{ block_id }} .bidly-theme-editor-placeholder {
    display: block !important;
  }

  /* Ensure block is selectable */
  #bidly-auction-list-{{ block_id }} {
    position: relative;
    min-height: 100px;
  }
  
  .bidly-loading {
    text-align: center;
    padding: 2rem;
  }
  
  .bidly-spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: bidly-spin 1s linear infinite;
    margin: 0 auto 1rem;
  }
  
  @keyframes bidly-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .bidly-error {
    background-color: #fee;
    border: 1px solid #fcc;
    border-radius: 4px;
    padding: 1rem;
    text-align: center;
    color: #c33;
  }
  
  .bidly-section-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    text-align: center;
  }
  
  .bidly-auctions-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    padding: 0;
    overflow-x: auto;
    scrollbar-width: thin;
    scrollbar-color: #ccc transparent;
  }
  
  .bidly-auctions-grid::-webkit-scrollbar {
    height: 6px;
  }
  
  .bidly-auctions-grid::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
  }
  
  .bidly-auctions-grid::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 3px;
  }
  
  .bidly-auctions-grid::-webkit-scrollbar-thumb:hover {
    background: #999;
  }
  
  .bidly-auction-card {
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    overflow: hidden;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    flex: 0 0 280px; /* Fixed width for horizontal layout */
    min-width: 280px;
    max-width: 320px;
  }
  
  .bidly-auction-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  .bidly-auction-actions {
    padding: 1rem;
    border-top: 1px solid #e1e5e9;
    background: #f8f9fa;
  }
  
  .bidly-view-details-button {
    width: 100%;
    padding: 0.75rem 1rem;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  
  .bidly-view-details-button:hover {
    background: #0056b3;
  }
  
  .bidly-auction-image {
    width: 100%;
    height: 200px;
    object-fit: contain;
    object-position: center;
    background-color: #f8f9fa;
  }
  
  .bidly-auction-content {
    padding: 1rem;
  }
  
  .bidly-auction-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    line-height: 1.3;
  }
  
  .bidly-auction-price {
    margin-bottom: 0.5rem;
  }
  
  .bidly-price-label {
    font-size: 0.8rem;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .bidly-price-amount {
    font-size: 1.25rem;
    font-weight: 700;
    color: #2c5aa0;
  }
  
  .bidly-starting-bid {
    font-size: 0.9rem;
    color: #888;
    margin-top: 0.25rem;
  }
  
  .bidly-auction-time {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 1rem;
  }
  
  .bidly-auction-status {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 1rem;
  }
  
  .bidly-status-active {
    background-color: #d4edda;
    color: #155724;
  }
  
  .bidly-status-pending {
    background-color: #fff3cd;
    color: #856404;
  }
  
  .bidly-status-ended {
    background-color: #f8d7da;
    color: #721c24;
  }
  
  .bidly-bid-section {
    margin-top: 1rem;
  }
  
  .bidly-bid-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
    margin-bottom: 0.5rem;
  }
  
  .bidly-bid-button {
    width: 100%;
    background-color: #2c5aa0;
    color: white;
    border: none;
    padding: 0.75rem;
    border-radius: 4px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  
  .bidly-bid-button:hover:not(:disabled) {
    background-color: #1e3f73;
  }
  
  .bidly-bid-button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }
  
  .bidly-buy-now-button {
    width: 100%;
    background-color: #28a745;
    color: white;
    border: none;
    padding: 0.75rem;
    border-radius: 4px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    margin-top: 0.5rem;
    transition: background-color 0.2s ease;
  }
  
  .bidly-buy-now-button:hover:not(:disabled) {
    background-color: #1e7e34;
  }
  
  .bidly-buy-now-button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }
  
  .bidly-customer-auth {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 1rem;
    margin-bottom: 1rem;
  }
  
  .bidly-auth-input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }
  
  .bidly-auth-button {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    font-size: 0.9rem;
    cursor: pointer;
  }
  
  .bidly-auth-button:hover {
    background-color: #5a6268;
  }
  
  .bidly-toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #28a745;
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    transform: translateX(100%);
    transition: transform 0.3s ease;
  }
  
  .bidly-toast.show {
    transform: translateX(0);
  }
  
  .bidly-toast.error {
    background-color: #dc3545;
  }
  
  @media (max-width: 768px) {
    .bidly-auctions-grid {
      flex-wrap: nowrap; /* Keep horizontal scroll on mobile */
    }
    
    .bidly-auction-card {
      flex: 0 0 250px; /* Smaller cards on mobile */
      min-width: 250px;
      max-width: 250px;
    }
  }
</style>

<script>
  (function() {
    // More robust theme editor detection
    const isThemeEditor = window.Shopify && (
      window.Shopify.designMode || 
      window.location.search.includes('preview_theme_id') ||
      document.body.classList.contains('shopify-design-mode') ||
      window.location.pathname.includes('editor') ||
      window.location.search.includes('oseid=')
    );
    
    if (isThemeEditor) {
      console.log('Bidly: Theme editor detected, showing placeholder');
      // Show placeholder immediately
      setTimeout(function() {
        const placeholder = document.querySelector('#bidly-auction-list-{{ block_id }} .bidly-theme-editor-placeholder');
        const loading = document.querySelector('#bidly-loading-{{ block_id }}');
        const container = document.querySelector('#bidly-auctions-{{ block_id }}');
        
        if (placeholder) placeholder.style.display = 'block';
        if (loading) loading.style.display = 'none';
        if (container) container.style.display = 'none';
      }, 50);
      return; // Exit early, don't load any scripts
    }
    
    // Wait for DOM to be ready and avoid conflicts
    function initBidlyWidget() {
      const blockId = '{{ block_id }}';
      const shopDomain = '{{ shop_domain }}';
      const appProxyUrl = '{{ app_proxy_url }}';
      
      // Double-check we're not in theme editor
      if (window.Shopify && window.Shopify.designMode) {
        return;
      }
      
      // Prevent conflicts with theme's predictive search
      if (window.predictiveSearch) {
        console.log('Bidly: Predictive search detected, preventing conflicts');
        // Temporarily disable predictive search for our block
        const originalResetSearch = window.predictiveSearch.resetSearch;
        if (originalResetSearch) {
          window.predictiveSearch.resetSearch = function() {
            // Only run if not in our block context
            if (!document.querySelector('#bidly-auction-list-{{ block_id }}')) {
              return originalResetSearch.apply(this, arguments);
            }
          };
        }
      }
      
      // Test App Proxy connection first
      console.log('🧪 Testing App Proxy connection...');
      fetch(`${appProxyUrl}/health?shop=${shopDomain}`)
        .then(response => response.json())
        .then(data => {
          console.log('✅ App Proxy health check:', data);
        })
        .catch(error => {
          console.error('❌ App Proxy health check failed:', error);
        });
      
      // Load the Bidly auction widget
      window.BidlyAuctionWidget = window.BidlyAuctionWidget || {};
      window.BidlyAuctionWidget.loadedInstances = window.BidlyAuctionWidget.loadedInstances || new Set();
      
      if (!window.BidlyAuctionWidget.loadedInstances.has(blockId)) {
        // Load CSS
        const cssLink = document.createElement('link');
        cssLink.rel = 'stylesheet';
        cssLink.href = '{{ "bidly-widget.css" | asset_url }}?v=2';
        cssLink.onerror = function() {
          console.warn('Bidly: Failed to load CSS');
        };
        document.head.appendChild(cssLink);
        
        // Load JavaScript
        const script = document.createElement('script');
        script.src = '{{ "bidly-widget.js" | asset_url }}?v=2';
        script.onload = function() {
          if (window.initBidlyBlock) {
            window.BidlyAuctionWidget.loadedInstances.add(blockId);
            window.initBidlyBlock(blockId, shopDomain, appProxyUrl, null, 'list');
          }
        };
        script.onerror = function() {
          console.error('Bidly: Failed to load JavaScript');
        };
        document.head.appendChild(script);
        
        window.BidlyAuctionWidget.loaded = true;
      } else {
        // Widget already loaded, initialize this block
        if (window.initBidlyBlock) {
          window.initBidlyBlock(blockId, shopDomain, appProxyUrl, null, 'list');
        }
      }
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initBidlyWidget);
    } else {
      initBidlyWidget();
    }
  })();
</script>

{% schema %}
{
  "name": "Auction List",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Live Auctions"
    },
    {
      "type": "range",
      "id": "max_auctions",
      "label": "Maximum Auctions to Display",
      "min": 1,
      "max": 20,
      "step": 1,
      "default": 6
    },
    {
      "type": "checkbox",
      "id": "show_ended",
      "label": "Show Ended Auctions",
      "default": false
    },
    {
      "type": "select",
      "id": "sort_by",
      "label": "Sort By",
      "options": [
        {
          "value": "newest",
          "label": "Newest First"
        },
        {
          "value": "ending_soon",
          "label": "Ending Soon"
        },
        {
          "value": "highest_bid",
          "label": "Highest Bid"
        }
      ],
      "default": "ending_soon"
    }
  ]
}
{% endschema %}
